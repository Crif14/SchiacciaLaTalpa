<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="static/css/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
</head>

<body id="body" style="font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif"
    background="static/image/sfondo.jpg">
    <div class="container mt-5">
        <div class="row">
            <!-- Colonna sinistra -->
            <div class="col-3 " id="punteggi">
                <h3>Classifica migliori punteggi</h3>
                <ol>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                </ol>
                <h3>
                    Ultimo punteggio
                </h3>
                <p id="ultimo"></p>
            </div>

            <!-- Colonna centrale -->
            <div class="col-5 center">
                <div class="container mt-5 " id="menuplay">
                    <h1 class="text-center mb-4">Game Menu</h1>
                    <div class="d-flex justify-content-center">
                        <button class="nes-btn is-primary" id="avviogioco">Avvia Gioco</button>
                        <div class="dropdown">
                            <button class="nes-btn is-success" type="button" id="difficultyDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Scegli Difficoltà
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="difficultyDropdown">
                                <li><a class="dropdown-item" href="#">Facile</a></li>
                                <li><a class="dropdown-item" href="#">Media</a></li>
                                <li><a class="dropdown-item" href="#">Difficile</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="cont-grid" class="hide">
                    <progress class="nes-progress is-pattern" id="progresso" max="30"></progress>
                    <i class="nes-icon is-large heart">
                    </i>
                    <i class="nes-icon is-large heart"></i>
                    <i class="nes-icon is-large heart"></i>
                    <div id="container-punteggio">
                        <h4>Il tuo punteggio</h4>
                        <h5 id="punteggio">0</h5>
                    </div>
                    <div class="griglia ">
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 1">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 2">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 3">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 4">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 5">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 6">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 7">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 8">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 9">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 10">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 11">
                        </div>
                        <div class="container-img">
                            <div class="giu mario">
                                <i class="nes-mario"></i>
                            </div>
                            <img src="static/image/tubo.png" alt="Immagine 12">
                        </div>
                    </div>
                    <input type="button" class="nes-btn is-error" id="botreset" value="Reset">
                </div>
            </div>

            <!--Colonna destra-->
            <div class="col-4" id="Info">
                <h3>Come si gioca</h3>
                <ul>
                    <li>
                        Scegliere la Difficoltà;
                    </li>
                    <li>
                        Schiacciare su "Avvia gioco" per iniziare a giocare;
                    </li>
                    <li>
                        Avrai 30 secondi per schiacciare più talpe possibili che in base alla difficolta scelta
                        appariranno e scompariranno più velocemente;
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div id="divfinegioco" class="finegioco">
        <div class="fineCenter">
            <h1 id="titolofine" class="press-start-2p-regular fineCentro">Game Over</h1>
            <p id="finePunteggio"></p>
            <input type="button" value="Rinizia" id="btnRinizia">
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        let finegioco = document.querySelector("#divfinegioco")
        let menuplay = document.querySelector("#menuplay")
        let contgrid = document.querySelector("#cont-grid")
        let selectedDifficulty = null;
        let talpe = document.querySelectorAll(".mario")
        let difficolta = document.querySelectorAll(".dropdown-item")
        let punthtml = document.querySelector("#punteggio")
        let talpadauscire = 0;
        let talpauscita = [];
        let cliccato = false
        let tienitempo = null;
        let tempo = 0;
        let uscitaTimer = null;
        let punteggio = 0;
        let sbarra = document.querySelector("#progresso");
        let tempistica = 0;
        function secondi() {
            tempistica = tempistica + 1;
            sbarra.value = tempistica;
            tienitempo = setTimeout(() => secondi(), 1000);
        }
        for (let i = 0; i < talpe.length; i++) {
            talpauscita[i] = false;
        }
        console.log(talpauscita);

        function generateRandomInteger(min, max) {
            let casualNumber = Math.random()
            casualNumber = casualNumber * (max - min + 1) + min
            casualNumber = parseInt(casualNumber)
            return casualNumber
        }

        //Funzione per aggiornare la classifica
        function aggiornaClassifica(punteggio) {
            //Seleziona gli elementi della classifica
            let classificaElementi = document.querySelectorAll("#punteggi ol li");
            let punteggi = [];

            //Raccogle i punteggi esistenti (evita elementi vuoti)
            for (let i = 0; i < classificaElementi.length; i++) {
                let valore = parseInt(classificaElementi[i].innerText);
                if (!isNaN(valore)) {
                    punteggi[i] = valore;
                } else {
                    punteggi[i] = 0; // Riempie con 0 se vuoto
                }
            }

            //Inserisce il nuovo punteggio al posto giusto nella classifica
            let inserito = false;
            for (let i = 0; i < punteggi.length; i++) {
                if (punteggio > punteggi[i]) {
                    // Sposta gli altri punteggi in basso
                    for (let j = punteggi.length - 1; j > i; j--) {
                        punteggi[j] = punteggi[j - 1];
                    }
                    punteggi[i] = punteggio;
                    inserito = true;
                    break;
                }
            }

            //Se il punteggio non è stato inserito ed è minore di tutti, lo mette in fondo
            if (!inserito && punteggi.length < classificaElementi.length) {
                punteggi[punteggi.length] = punteggio;
            }

            //Aggiorna il contenuto HTML della classifica
            for (let i = 0; i < classificaElementi.length; i++) {
                classificaElementi[i].innerText = punteggi[i] !== 0 ? punteggi[i] : "";
            }

            //Aggiorna l'ultimo punteggio
            document.querySelector("#ultimo").innerText = punteggio;
        }

        //Funzioni cambio gradiente fine
        function cambioOverlayRosso() {
            finegioco.classList.replace("overlayGiallo", "overlayRosso")
            overlayGiallo = setTimeout(() => {
                cambioOverlayGiallo();
            }, 1000);
        }
        function cambioOverlayGiallo() {
            finegioco.classList.replace("overlayRosso", "overlayGiallo")
            overlayRosso = setTimeout(() => {
                cambioOverlayRosso();
            }, 1000);
        }

        //Funzione per iniziare il gioco
        function startGame() {
            if (!selectedDifficulty) {
                document.querySelector('#difficultyDropdown').classList.remove('is-primary');
                document.querySelector('#difficultyDropdown').classList.add('is-error');
                console.log('Seleziona una difficoltà prima di avviare il gioco!');
            } else {
                console.log('Gioco avviato con difficoltà: ' + selectedDifficulty);
                menuplay.classList.add("hide")
                contgrid.classList.remove("hide")
                if (selectedDifficulty = "Difficile") {
                    tempo = 500
                } else if (selectedDifficulty = "Medio") {
                    tempo = 1000
                } else {
                    tempo = 1500
                }
                uscita()
            }
        }

        //Funzione per mpostare la difficolta
        function setDifficulty(level) {
            selectedDifficulty = level;
            document.querySelector('#difficultyDropdown').classList.remove('btn-danger');
            document.querySelector('#difficultyDropdown').classList.add('btn-secondary');
            document.querySelector('#difficultyDropdown').innerText = 'Difficoltà: ' + level;
        }

        //Funzione per uscita delle talpe
        function uscita() {
            if (tempistica < 30) {
                if (uscitaTimer !== null) {
                    clearTimeout(uscitaTimer); // Ferma il timer precedente, se esiste
                }
                talpadauscire = generateRandomInteger(0, 11);
                talpauscita[talpadauscire] = true;

                talpe[talpadauscire].classList.replace("giu", "torna");
                console.log("Talpa uscita: " + talpadauscire);

                // Dopo un certo tempo, la talpa sparisce di nuovo
                uscitaTimer = setTimeout(() => {
                    talpe[talpadauscire].classList.replace("torna", "giu");
                    talpauscita[talpadauscire] = false;
                    uscita(); // Richiama la funzione per continuare il ciclo
                }, tempo);

                cliccato = false;
            } else {
                clearTimeout(uscitaTimer);
                clearTimeout(tienitempo);
                talpe[talpadauscire].classList.replace("torna", "giu");
                talpauscita[talpadauscire] = false;
                // Aggiorna la classifica con il punteggio finale
                aggiornaClassifica(punteggio);
                //Discesa overlay finegioco
                finegioco.classList.add("overlayRosso", "visible")
                let puntfine = document.querySelector("#finePunteggio")
                puntfine.innerText = "Gioco terminato. Punteggio finale: " + punteggio
                setTimeout(() => {
                    cambioOverlayGiallo();
                }, 1000);
                console.log("Gioco terminato. Punteggio finale: " + punteggio);
            }
        }

        //Eventlistener che avvia il gioco 
        document.querySelector('#avviogioco').addEventListener("click", function (event) {
            startGame();
            tienitempo = setTimeout(() => secondi(), 1000);
        })

        //Per impostare la difficolta
        for (let i = 0; i < difficolta.length; i++) {
            difficolta[i].addEventListener("click", function (event) {
                let el = event.currentTarget;
                let difficulty = el.innerText;  //Ottiene il testo dell'elemento
                setDifficulty(difficulty);  //Imposta la difficoltà
                console.log("Difficoltà selezionata: " + difficulty);
            })
        }
        //Funzione talpa cliccata 
        for (let i = 0; i < talpe.length; i++) {
            talpe[i].addEventListener("click", function (event) {
                if (tempistica < 30) {
                    let el = event.currentTarget;
                    let j = Array.from(talpe).indexOf(el);
                    if (talpauscita[j] == true) {
                        cliccato = true;
                        talpe[talpadauscire].classList.replace("torna", "giu");
                        talpauscita[j] = false;
                        clearTimeout(uscitaTimer);
                        uscita();
                        punteggio = punteggio + 100
                        punthtml.innerHTML = punteggio
                    }
                }
            });
        }
        document.querySelector('#btnRinizia').addEventListener('click', function () {
            //Nasconde l'overlay e la griglia di fine gioco e mostra il menu principale
            finegioco.classList.remove("visible");
            menuplay.classList.remove("hide");
            contgrid.classList.add("hide")
            // Reset delle talpe
            for (let i = 0; i < talpe.length; i++) {
                talpe[i].classList.replace("torna", "giu");
                talpauscita[i] = false;
            }
            // Reset delle variabili di gioco
            clearTimeout(tienitempo);
            clearTimeout(uscitaTimer);
            tempistica = 0;
            punteggio = 0;
            sbarra.value = 0;
            selectedDifficulty = null;
            // Ripristina il dropdown delle difficoltà
            document.querySelector('#difficultyDropdown').innerText = 'Scegli Difficoltà';
            document.querySelector('#difficultyDropdown').classList.remove('is-error');
        });

        document.querySelector('#botreset').addEventListener("click", function () {
            // Nascondi la griglia di gioco e mostra il menu principale
            menuplay.classList.remove("hide");
            contgrid.classList.add("hide");
            //Reset delle talpe
            for (let i = 0; i < 12; i++) {
                talpe[i].classList.replace("torna", "giu");
            }
            // Reset delle variabili 
            clearTimeout(tienitempo);
            clearTimeout(uscitaTimer);
            tempistica = 0;
            punteggio = 0;
            punthtml.innerHTML = punteggio;
            // Resetta la barra di progresso
            sbarra.value = 0;
            console.log("Gioco resettato. Tornato al menu principale.");
        });




    </script>
</body>

</html>